[{"filename": "lib/Conversion/TritonToTritonGPU/TritonToTritonGPUPass.cpp", "status": "modified", "additions": 65, "deletions": 36, "changes": 101, "file_content_changes": "@@ -36,8 +36,9 @@ template <class Op> class GenericOpPattern : public OpConversionPattern<Op> {\n   matchAndRewrite(Op op, typename Op::Adaptor adaptor,\n                   ConversionPatternRewriter &rewriter) const override {\n     Type retType = this->getTypeConverter()->convertType(op.getType());\n-    addNamedAttrs(rewriter.replaceOpWithNewOp<Op>(op, retType, adaptor.getOperands()), \n-      adaptor.getAttributes());\n+    addNamedAttrs(\n+        rewriter.replaceOpWithNewOp<Op>(op, retType, adaptor.getOperands()),\n+        adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -51,8 +52,10 @@ class ArithCmpPattern : public OpConversionPattern<SrcOp> {\n   matchAndRewrite(SrcOp op, typename SrcOp::Adaptor adaptor,\n                   ConversionPatternRewriter &rewriter) const override {\n     Type retType = this->getTypeConverter()->convertType(op.getType());\n-    addNamedAttrs(rewriter.replaceOpWithNewOp<DstOp>(op, retType, adaptor.getPredicate(),\n-                                       adaptor.getLhs(), adaptor.getRhs()), adaptor.getAttributes());\n+    addNamedAttrs(\n+        rewriter.replaceOpWithNewOp<DstOp>(op, retType, adaptor.getPredicate(),\n+                                           adaptor.getLhs(), adaptor.getRhs()),\n+        adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -73,7 +76,9 @@ class ArithConstantPattern : public OpConversionPattern<arith::ConstantOp> {\n     else\n       // This is a hack. We just want to add encoding\n       value = value.reshape(retType);\n-    addNamedAttrs(rewriter.replaceOpWithNewOp<arith::ConstantOp>(op, retType, value), adaptor.getAttributes());\n+    addNamedAttrs(\n+        rewriter.replaceOpWithNewOp<arith::ConstantOp>(op, retType, value),\n+        adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -146,8 +151,9 @@ class StdSelectPattern : public OpConversionPattern<arith::SelectOp> {\n                   ConversionPatternRewriter &rewriter) const override {\n     Type retType = this->getTypeConverter()->convertType(op.getType());\n     addNamedAttrs(rewriter.replaceOpWithNewOp<triton::gpu::SelectOp>(\n-        op, retType, adaptor.getCondition(), adaptor.getTrueValue(),\n-        adaptor.getFalseValue()), adaptor.getAttributes());\n+                      op, retType, adaptor.getCondition(),\n+                      adaptor.getTrueValue(), adaptor.getFalseValue()),\n+                  adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -185,7 +191,8 @@ struct TritonMakeRangePattern\n                   ConversionPatternRewriter &rewriter) const override {\n     Type retType = getTypeConverter()->convertType(op.getType());\n     addNamedAttrs(rewriter.replaceOpWithNewOp<triton::MakeRangeOp>(\n-        op, retType, adaptor.getStart(), adaptor.getEnd()), adaptor.getAttributes());\n+                      op, retType, adaptor.getStart(), adaptor.getEnd()),\n+                  adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -228,8 +235,9 @@ struct TritonExpandDimsPattern\n     // construct new op\n     auto newSrc = rewriter.create<triton::gpu::ConvertLayoutOp>(\n         op.getLoc(), newArgType, adaptor.getSrc());\n-    addNamedAttrs(rewriter.replaceOpWithNewOp<triton::ExpandDimsOp>(op, newSrc,\n-                                                      adaptor.getAxis()), adaptor.getAttributes());\n+    addNamedAttrs(rewriter.replaceOpWithNewOp<triton::ExpandDimsOp>(\n+                      op, newSrc, adaptor.getAxis()),\n+                  adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -281,8 +289,9 @@ struct TritonDotPattern : public OpConversionPattern<triton::DotOp> {\n     }\n     c = rewriter.create<triton::gpu::ConvertLayoutOp>(c.getLoc(), retType, c);\n \n-    addNamedAttrs(rewriter.replaceOpWithNewOp<triton::DotOp>(op, retType, a, b, c,\n-                                               adaptor.getAllowTF32()), adaptor.getAttributes());\n+    addNamedAttrs(rewriter.replaceOpWithNewOp<triton::DotOp>(\n+                      op, retType, a, b, c, adaptor.getAllowTF32()),\n+                  adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -297,8 +306,9 @@ struct TritonCatPattern : public OpConversionPattern<triton::CatOp> {\n     // For now, this behaves like generic, but this will evolve when\n     // we add support for `can_reorder=False`\n     Type retType = this->getTypeConverter()->convertType(op.getType());\n-    addNamedAttrs(rewriter.replaceOpWithNewOp<triton::CatOp>(op, retType,\n-                                               adaptor.getOperands()), adaptor.getAttributes());\n+    addNamedAttrs(rewriter.replaceOpWithNewOp<triton::CatOp>(\n+                      op, retType, adaptor.getOperands()),\n+                  adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -330,7 +340,8 @@ struct TritonTransPattern : public OpConversionPattern<triton::TransOp> {\n       src = rewriter.create<triton::gpu::ConvertLayoutOp>(src.getLoc(), srcType,\n                                                           src);\n     }\n-    addNamedAttrs(rewriter.replaceOpWithNewOp<triton::TransOp>(op, src), adaptor.getAttributes());\n+    addNamedAttrs(rewriter.replaceOpWithNewOp<triton::TransOp>(op, src),\n+                  adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -342,9 +353,11 @@ struct TritonLoadPattern : public OpConversionPattern<triton::LoadOp> {\n   matchAndRewrite(triton::LoadOp op, OpAdaptor adaptor,\n                   ConversionPatternRewriter &rewriter) const override {\n     addNamedAttrs(rewriter.replaceOpWithNewOp<triton::LoadOp>(\n-        op, typeConverter->convertType(op.getType()), adaptor.getPtr(),\n-        adaptor.getMask(), adaptor.getOther(), adaptor.getCache(),\n-        adaptor.getEvict(), adaptor.getIsVolatile()), adaptor.getAttributes());\n+                      op, typeConverter->convertType(op.getType()),\n+                      adaptor.getPtr(), adaptor.getMask(), adaptor.getOther(),\n+                      adaptor.getCache(), adaptor.getEvict(),\n+                      adaptor.getIsVolatile()),\n+                  adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -356,8 +369,10 @@ struct TritonStorePattern : public OpConversionPattern<triton::StoreOp> {\n   matchAndRewrite(triton::StoreOp op, OpAdaptor adaptor,\n                   ConversionPatternRewriter &rewriter) const override {\n     addNamedAttrs(rewriter.replaceOpWithNewOp<triton::StoreOp>(\n-        op, adaptor.getPtr(), adaptor.getValue(), adaptor.getMask(),\n-        adaptor.getCache(), adaptor.getEvict()), adaptor.getAttributes());\n+                      op, adaptor.getPtr(), adaptor.getValue(),\n+                      adaptor.getMask(), adaptor.getCache(),\n+                      adaptor.getEvict()),\n+                  adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -370,8 +385,9 @@ struct TritonAtomicCASPattern\n   matchAndRewrite(triton::AtomicCASOp op, OpAdaptor adaptor,\n                   ConversionPatternRewriter &rewriter) const override {\n     addNamedAttrs(rewriter.replaceOpWithNewOp<triton::AtomicCASOp>(\n-        op, typeConverter->convertType(op.getType()), adaptor.getPtr(),\n-        adaptor.getCmp(), adaptor.getVal()), adaptor.getAttributes());\n+                      op, typeConverter->convertType(op.getType()),\n+                      adaptor.getPtr(), adaptor.getCmp(), adaptor.getVal()),\n+                  adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -384,8 +400,10 @@ struct TritonAtomicRMWPattern\n   matchAndRewrite(triton::AtomicRMWOp op, OpAdaptor adaptor,\n                   ConversionPatternRewriter &rewriter) const override {\n     addNamedAttrs(rewriter.replaceOpWithNewOp<triton::AtomicRMWOp>(\n-        op, typeConverter->convertType(op.getType()), adaptor.getAtomicRmwOp(),\n-        adaptor.getPtr(), adaptor.getVal(), adaptor.getMask()), adaptor.getAttributes());\n+                      op, typeConverter->convertType(op.getType()),\n+                      adaptor.getAtomicRmwOp(), adaptor.getPtr(),\n+                      adaptor.getVal(), adaptor.getMask()),\n+                  adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -398,8 +416,10 @@ struct TritonExtElemwisePattern\n   matchAndRewrite(triton::ExtElemwiseOp op, OpAdaptor adaptor,\n                   ConversionPatternRewriter &rewriter) const override {\n     addNamedAttrs(rewriter.replaceOpWithNewOp<triton::ExtElemwiseOp>(\n-        op, typeConverter->convertType(op.getType()), adaptor.getArgs(),\n-        adaptor.getLibname(), adaptor.getLibpath(), adaptor.getSymbol()), adaptor.getAttributes());\n+                      op, typeConverter->convertType(op.getType()),\n+                      adaptor.getArgs(), adaptor.getLibname(),\n+                      adaptor.getLibpath(), adaptor.getSymbol()),\n+                  adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -412,7 +432,9 @@ struct TritonGenericPattern : public OpConversionPattern<Op> {\n   matchAndRewrite(Op op, typename Op::Adaptor adaptor,\n                   ConversionPatternRewriter &rewriter) const override {\n     Type retType = this->getTypeConverter()->convertType(op.getType());\n-    addNamedAttrs(rewriter.replaceOpWithNewOp<Op>(op, retType, adaptor.getOperands()), adaptor.getAttributes());\n+    addNamedAttrs(\n+        rewriter.replaceOpWithNewOp<Op>(op, retType, adaptor.getOperands()),\n+        adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -433,8 +455,9 @@ struct TritonBroadcastPattern\n     Type retType = RankedTensorType::get(opType.getShape(),\n                                          opType.getElementType(), srcEncoding);\n     // Type retType = this->getTypeConverter()->convertType(op.getType());\n-    addNamedAttrs(rewriter.replaceOpWithNewOp<triton::BroadcastOp>(op, retType,\n-                                                     adaptor.getOperands()), adaptor.getAttributes());\n+    addNamedAttrs(rewriter.replaceOpWithNewOp<triton::BroadcastOp>(\n+                      op, retType, adaptor.getOperands()),\n+                  adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -445,8 +468,10 @@ struct TritonReducePattern : public OpConversionPattern<triton::ReduceOp> {\n   LogicalResult\n   matchAndRewrite(triton::ReduceOp op, OpAdaptor adaptor,\n                   ConversionPatternRewriter &rewriter) const override {\n-    addNamedAttrs(rewriter.replaceOpWithNewOp<triton::ReduceOp>(\n-        op, adaptor.getRedOp(), adaptor.getOperand(), adaptor.getAxis()), adaptor.getAttributes());\n+    addNamedAttrs(\n+        rewriter.replaceOpWithNewOp<triton::ReduceOp>(\n+            op, adaptor.getRedOp(), adaptor.getOperand(), adaptor.getAxis()),\n+        adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -457,8 +482,9 @@ struct TritonPrintfPattern : public OpConversionPattern<triton::PrintfOp> {\n   LogicalResult\n   matchAndRewrite(PrintfOp op, typename PrintfOp::Adaptor adaptor,\n                   ConversionPatternRewriter &rewriter) const override {\n-    addNamedAttrs(rewriter.replaceOpWithNewOp<triton::PrintfOp>(op, op.getPrefixAttr(),\n-                                                  adaptor.getOperands()), adaptor.getAttributes());\n+    addNamedAttrs(rewriter.replaceOpWithNewOp<triton::PrintfOp>(\n+                      op, op.getPrefixAttr(), adaptor.getOperands()),\n+                  adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -537,7 +563,9 @@ struct SCFYieldPattern : public OpConversionPattern<scf::YieldOp> {\n     // rewriter.setInsertionPointToEnd(rewriter.getInsertionBlock());\n     // rewriter.create<scf::YieldOp>(op.getLoc(), adaptor.getOperands());\n     // op.erase();\n-    addNamedAttrs(rewriter.replaceOpWithNewOp<scf::YieldOp>(op, adaptor.getOperands()), adaptor.getAttributes());\n+    addNamedAttrs(\n+        rewriter.replaceOpWithNewOp<scf::YieldOp>(op, adaptor.getOperands()),\n+        adaptor.getAttributes());\n     return success();\n   }\n };\n@@ -642,8 +670,9 @@ class CFBranchPattern : public OpConversionPattern<cf::BranchOp> {\n   LogicalResult\n   matchAndRewrite(cf::BranchOp op, cf::BranchOp::Adaptor adaptor,\n                   ConversionPatternRewriter &rewriter) const override {\n-    addNamedAttrs(rewriter.replaceOpWithNewOp<cf::BranchOp>(op, op.getSuccessor(),\n-                                              adaptor.getOperands()), adaptor.getAttributes());\n+    addNamedAttrs(rewriter.replaceOpWithNewOp<cf::BranchOp>(\n+                      op, op.getSuccessor(), adaptor.getOperands()),\n+                  adaptor.getAttributes());\n     return success();\n   }\n };"}, {"filename": "python/test/unit/language/test_core.py", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "file_content_changes": "@@ -1418,7 +1418,8 @@ def test_vectorization_hints(has_hints):\n \n     @triton.jit\n     def _kernel(dst, src, off, N, BLOCK_SIZE: tl.constexpr, HINT: tl.constexpr):\n-        offsets = tl.program_id(0) * BLOCK_SIZE + tl.load(off) + tl.arange(0, BLOCK_SIZE)\n+        offsets = tl.program_id(0) * BLOCK_SIZE + tl.arange(0, BLOCK_SIZE)\n+        offsets = offsets + tl.load(off)\n         if HINT:\n             tl.max_contiguous(tl.multiple_of(offsets, 1024), 1024)\n         x = tl.load(src + offsets, mask=offsets < N)"}]