[{"filename": "lib/codegen/analysis/layout.cc", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "file_content_changes": "@@ -234,7 +234,15 @@ mma_layout::mma_layout(size_t num_warps,\n     // try to have a warp own entire rows of the output\n     // this makes it easier to fuse multiple mmas by fusing\n     // registers\n-    if(shape[0] / spw_[0] >= num_warps){\n+    bool one_warp_per_row = false;\n+    for(ir::value* v: values)\n+    for(ir::user* u: v->get_users()){\n+      auto* dot = dynamic_cast<ir::dot_inst*>(u);\n+      if((dot && dot->get_operand(2)!=v) || !layout_a->to_shared())\n+        one_warp_per_row = shape[0] / spw_[0] >= num_warps;\n+    }\n+\n+    if(one_warp_per_row){\n       wpt_[1] = 1;\n       wpt_[0] = num_warps;\n     }"}]