[{"filename": "python/triton/compiler/__init__.py", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "file_content_changes": "@@ -1,4 +1,5 @@\n-from .compiler import CompiledKernel, compile, instance_descriptor\n+from .compiler import (CompiledKernel, compile, get_arch_default_num_stages,\n+                       get_arch_default_num_warps, instance_descriptor)\n from .errors import CompilationError\n \n-__all__ = [\"compile\", \"instance_descriptor\", \"CompiledKernel\", \"CompilationError\"]\n+__all__ = [\"compile\", \"instance_descriptor\", \"CompiledKernel\", \"CompilationError\", \"get_arch_default_num_warps\", \"get_arch_default_num_stages\"]"}, {"filename": "python/triton/compiler/compiler.py", "status": "modified", "additions": 33, "deletions": 2, "changes": 35, "file_content_changes": "@@ -368,6 +368,32 @@ def get_architecture_descriptor(capability):\n     return capability\n \n \n+def get_arch_default_num_warps(device_type):\n+    if device_type in [\"cuda\", \"hip\"]:\n+        num_warps = 4\n+    else:\n+        _device_backend = get_backend(device_type)\n+        assert _device_backend\n+        arch = _device_backend.get_architecture_descriptor()\n+        num_warps = arch[\"num_warps\"]\n+\n+    return num_warps\n+\n+\n+def get_arch_default_num_stages(device_type):\n+    if device_type in [\"cuda\", \"hip\"]:\n+        arch = get_architecture_descriptor(None)\n+        is_cuda = device_type == \"cuda\" and _is_cuda(arch)\n+        num_stages = 3 if is_cuda and arch >= 75 else 2\n+    else:\n+        _device_backend = get_backend(device_type)\n+        assert _device_backend\n+        arch = _device_backend.get_architecture_descriptor()\n+        num_stages = arch[\"num_stages\"]\n+\n+    return num_stages\n+\n+\n def add_rocm_stages(arch, extern_libs, stages):\n     extern_libs.update(get_amdgcn_bitcode_paths(arch))\n \n@@ -409,9 +435,10 @@ def compile(fn, **kwargs):\n     is_hip = device_type in [\"cuda\", \"hip\"] and not is_cuda\n     context = ir.context()\n     constants = kwargs.get(\"constants\", dict())\n-    num_warps = kwargs.get(\"num_warps\", 4)\n+    num_warps = kwargs.get(\"num_warps\", get_arch_default_num_warps(device_type))\n+    assert num_warps > 0 and (num_warps & (num_warps - 1)) == 0, \"num_warps must be a power of 2\"\n     num_ctas = kwargs.get(\"num_ctas\", 1)\n-    num_stages = kwargs.get(\"num_stages\", 3 if is_cuda and arch >= 75 else 2)\n+    num_stages = kwargs.get(\"num_stages\", get_arch_default_num_stages(device_type))\n     # TODO[shuhaoj]: Default should be to enable warp specialization once possible\n     enable_warp_specialization = kwargs.get(\"enable_warp_specialization\", False)\n     # TODO[shuhaoj]: persistent can be decoupled with warp specialization\n@@ -445,6 +472,10 @@ def compile(fn, **kwargs):\n     elif is_hip:\n         add_rocm_stages(arch, extern_libs, stages)\n     else:\n+        # pass the user's configuration to the backend device.\n+        arch[\"num_warps\"] = num_warps\n+        arch[\"num_stages\"] = num_stages\n+        arch[\"num_ctas\"] = num_ctas\n         _device_backend.add_stages(arch, extern_libs, stages)\n \n     # find out the signature of the function"}, {"filename": "python/triton/runtime/jit.py", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "file_content_changes": "@@ -362,15 +362,11 @@ def _make_launcher(self):\n         args_signature = args_signature + ', ' if len(args_signature) > 0 else ''\n \n         src = f\"\"\"\n-def {self.fn.__name__}({args_signature}grid=None, num_warps=4, num_ctas=1, num_stages=3, enable_warp_specialization=False, extern_libs=None, stream=None, warmup=False, device=None, device_type=None):\n-    from ..compiler import compile, CompiledKernel\n+def {self.fn.__name__}({args_signature}grid=None, num_warps=None, num_ctas=1, num_stages=None, enable_warp_specialization=False, extern_libs=None, stream=None, warmup=False, device=None, device_type=None):\n+    from ..compiler import compile, CompiledKernel, get_arch_default_num_warps, get_arch_default_num_stages\n     sig_key = {f'{sig_keys},' if len(sig_keys) > 0 else ()}\n     constexpr_key = {f'{constexpr_keys},' if len(constexpr_keys) > 0 else ()}\n     spec_key = {f'{spec_keys},' if len(spec_keys) > 0 else ()}\n-    key = (version_key, sig_key, constexpr_key, spec_key, num_warps, num_ctas, num_stages, enable_warp_specialization, self.debug)\n-    if not extern_libs is None:\n-      key = (key, tuple(extern_libs.items()))\n-    assert num_warps > 0 and (num_warps & (num_warps - 1)) == 0, \"num_warps must be a power of 2\"\n     assert num_ctas > 0\n     assert grid is not None\n     if callable(grid):\n@@ -390,6 +386,15 @@ def {self.fn.__name__}({args_signature}grid=None, num_warps=4, num_ctas=1, num_s\n         if device_backend is None:\n             raise ValueError('Cannot find backend for ' + device_type)\n \n+    if num_warps is None:\n+        num_warps = get_arch_default_num_warps(device_type)\n+    if num_stages is None:\n+        num_stages = get_arch_default_num_stages(device_type)\n+\n+    key = (version_key, sig_key, constexpr_key, spec_key, num_warps, num_ctas, num_stages, enable_warp_specialization, self.debug)\n+    if not extern_libs is None:\n+      key = (key, tuple(extern_libs.items()))\n+\n     if device is None:\n         if device_type in ['cuda', 'hip']:\n             device = get_current_device()"}]