[{"filename": "include/triton/Dialect/Triton/IR/TritonOps.td", "status": "modified", "additions": 19, "deletions": 17, "changes": 36, "file_content_changes": "@@ -6,10 +6,10 @@ include \"triton/Dialect/Triton/IR/TritonTypes.td\"\n include \"triton/Dialect/Triton/IR/TritonAttrDefs.td\"\n include \"triton/Dialect/Triton/IR/TritonInterfaces.td\"\n include \"mlir/IR/OpBase.td\"\n-include \"mlir/Interfaces/SideEffectInterfaces.td\" // NoMemoryEffect\n+include \"mlir/Interfaces/SideEffectInterfaces.td\" // Pure\n include \"mlir/Interfaces/ControlFlowInterfaces.td\" // BranchOpInterface\n include \"mlir/Interfaces/InferTypeOpInterface.td\" // SameOperandsAndResultType\n-include \"mlir/Interfaces/SideEffectInterfaces.td\" // NoMemoryEffect\n+include \"mlir/Interfaces/SideEffectInterfaces.td\" // Pure\n include \"mlir/Interfaces/CastInterfaces.td\" // CastOpInterface\n \n //\n@@ -29,7 +29,7 @@ class TT_Op<string mnemonic, list<Trait> traits = []> :\n //   extui, extsi, tructi\n def TT_IntToPtrOp : TT_Op<\"int_to_ptr\", [SameOperandsAndResultShape,\n                                          SameOperandsAndResultEncoding,\n-                                         NoMemoryEffect,\n+                                         Pure,\n                                          /*DeclareOpInterfaceMethods<CastOpInterface>*/]> {\n     let summary = \"Cast int64 to pointer\";\n \n@@ -42,7 +42,7 @@ def TT_IntToPtrOp : TT_Op<\"int_to_ptr\", [SameOperandsAndResultShape,\n \n def TT_PtrToIntOp : TT_Op<\"ptr_to_int\", [SameOperandsAndResultShape,\n                                          SameOperandsAndResultEncoding,\n-                                         NoMemoryEffect,\n+                                         Pure,\n                                          /*DeclareOpInterfaceMethods<CastOpInterface>*/]> {\n     let summary = \"Cast pointer to int64\";\n \n@@ -56,7 +56,7 @@ def TT_PtrToIntOp : TT_Op<\"ptr_to_int\", [SameOperandsAndResultShape,\n // arith.bitcast doesn't support pointers\n def TT_BitcastOp : TT_Op<\"bitcast\", [SameOperandsAndResultShape,\n                                      SameOperandsAndResultEncoding,\n-                                     NoMemoryEffect,\n+                                     Pure,\n                                      /*DeclareOpInterfaceMethods<CastOpInterface>*/]> {\n     let summary = \"Cast between types of the same bitwidth\";\n \n@@ -71,7 +71,7 @@ def TT_BitcastOp : TT_Op<\"bitcast\", [SameOperandsAndResultShape,\n \n def TT_FpToFpOp : TT_Op<\"fp_to_fp\", [SameOperandsAndResultShape,\n                                      SameOperandsAndResultEncoding,\n-                                     NoMemoryEffect,\n+                                     Pure,\n                                      DeclareOpInterfaceMethods<CastOpInterface>]> {\n     let summary = \"Floating point casting for custom types\";\n \n@@ -95,7 +95,7 @@ def TT_FpToFpOp : TT_Op<\"fp_to_fp\", [SameOperandsAndResultShape,\n //\n \n def TT_AddPtrOp : TT_Op<\"addptr\",\n-                     [NoMemoryEffect,\n+                     [Pure,\n                       SameOperandsAndResultShape,\n                       SameOperandsAndResultEncoding,\n                       TypesMatchWith<\"result type matches ptr type\",\n@@ -222,7 +222,7 @@ def TT_AtomicCASOp : TT_Op<\"atomic_cas\", [MemoryEffects<[MemRead]>,\n //\n // Shape Manipulation Ops\n //\n-def TT_SplatOp : TT_Op<\"splat\", [NoMemoryEffect,\n+def TT_SplatOp : TT_Op<\"splat\", [Pure,\n                                  SameOperandsAndResultElementType,\n                                  SameOperandsAndResultEncoding]> {\n     let summary = \"splat\";\n@@ -236,7 +236,7 @@ def TT_SplatOp : TT_Op<\"splat\", [NoMemoryEffect,\n     let hasFolder = 1;\n }\n \n-def TT_ExpandDimsOp : TT_Op<\"expand_dims\", [NoMemoryEffect,\n+def TT_ExpandDimsOp : TT_Op<\"expand_dims\", [Pure,\n                                             DeclareOpInterfaceMethods<InferTypeOpInterface>,\n                                             SameOperandsAndResultElementType]> {\n     let summary = \"expand_dims\";\n@@ -248,6 +248,7 @@ def TT_ExpandDimsOp : TT_Op<\"expand_dims\", [NoMemoryEffect,\n     let assemblyFormat = \"$src attr-dict `:` functional-type(operands, results)\";\n }\n \n+// view is not `pure` because it may reorder elements\n def TT_ViewOp : TT_Op<\"view\", [NoMemoryEffect,\n                                SameOperandsAndResultElementType]> {\n     let summary = \"view\";\n@@ -260,7 +261,7 @@ def TT_ViewOp : TT_Op<\"view\", [NoMemoryEffect,\n \n }\n \n-def TT_BroadcastOp : TT_Op<\"broadcast\", [NoMemoryEffect,\n+def TT_BroadcastOp : TT_Op<\"broadcast\", [Pure,\n                                          SameOperandsAndResultElementType,\n                                          SameOperandsAndResultEncoding]> {\n     let summary = \"broadcast. No left-padding as of now.\";\n@@ -274,6 +275,7 @@ def TT_BroadcastOp : TT_Op<\"broadcast\", [NoMemoryEffect,\n     let hasFolder = 1;\n }\n \n+// cat is not `pure` because it may reorder elements\n def TT_CatOp : TT_Op<\"cat\", [NoMemoryEffect,\n                              SameOperandsAndResultElementType]> {\n     let summary = \"concatenate 2 tensors\";\n@@ -285,7 +287,7 @@ def TT_CatOp : TT_Op<\"cat\", [NoMemoryEffect,\n     let assemblyFormat = \"$lhs `,` $rhs attr-dict `:` functional-type(operands, results)\";\n }\n \n-def TT_TransOp : TT_Op<\"trans\", [NoMemoryEffect,\n+def TT_TransOp : TT_Op<\"trans\", [Pure,\n                                  DeclareOpInterfaceMethods<InferTypeOpInterface>,\n                                  SameOperandsAndResultElementType]> {\n \n@@ -301,15 +303,15 @@ def TT_TransOp : TT_Op<\"trans\", [NoMemoryEffect,\n //\n // SPMD Ops\n //\n-def TT_GetProgramIdOp : TT_Op<\"get_program_id\", [NoMemoryEffect]> {\n+def TT_GetProgramIdOp : TT_Op<\"get_program_id\", [Pure]> {\n     let arguments = (ins I32Attr:$axis);\n \n     let results = (outs I32:$result);\n \n     let assemblyFormat = \"attr-dict `:` type($result)\";\n }\n \n-def TT_GetNumProgramsOp : TT_Op<\"get_num_programs\", [NoMemoryEffect]> {\n+def TT_GetNumProgramsOp : TT_Op<\"get_num_programs\", [Pure]> {\n     let arguments = (ins I32Attr:$axis);\n \n     let results = (outs I32:$result);\n@@ -320,7 +322,7 @@ def TT_GetNumProgramsOp : TT_Op<\"get_num_programs\", [NoMemoryEffect]> {\n //\n // Dot Op\n //\n-def TT_DotOp : TT_Op<\"dot\", [NoMemoryEffect,\n+def TT_DotOp : TT_Op<\"dot\", [Pure,\n                              DeclareOpInterfaceMethods<InferTypeOpInterface>,\n                              TypesMatchWith<\"result's type matches accumulator's type\",\n                                             \"d\", \"c\", \"$_self\">]> {\n@@ -340,7 +342,7 @@ def TT_DotOp : TT_Op<\"dot\", [NoMemoryEffect,\n //\n // Reduce Op\n //\n-def TT_ReduceOp : TT_Op<\"reduce\", [NoMemoryEffect,\n+def TT_ReduceOp : TT_Op<\"reduce\", [Pure,\n                                    DeclareOpInterfaceMethods<InferTypeOpInterface>]> {\n     let summary = \"reduce\";\n \n@@ -364,7 +366,7 @@ def TT_ReduceOp : TT_Op<\"reduce\", [NoMemoryEffect,\n //\n // External elementwise op\n //\n-def TT_ExtElemwiseOp : TT_Op<\"ext_elemwise\", [NoMemoryEffect, Elementwise, SameOperandsAndResultShape,\n+def TT_ExtElemwiseOp : TT_Op<\"ext_elemwise\", [Pure, Elementwise, SameOperandsAndResultShape,\n                                               SameOperandsAndResultEncoding,\n                                               SameVariadicOperandSize]> {\n     let summary = \"ext_elemwise\";\n@@ -386,7 +388,7 @@ def TT_ExtElemwiseOp : TT_Op<\"ext_elemwise\", [NoMemoryEffect, Elementwise, SameO\n // Make Range Op\n //\n // TODO: should have ConstantLike as Trait\n-def TT_MakeRangeOp : TT_Op<\"make_range\", [NoMemoryEffect]> {\n+def TT_MakeRangeOp : TT_Op<\"make_range\", [Pure]> {\n     let summary = \"make range\";\n \n     let description = [{"}, {"filename": "include/triton/Dialect/TritonGPU/IR/TritonGPUOps.td", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "file_content_changes": "@@ -7,7 +7,7 @@ include \"mlir/Dialect/Arith/IR/ArithBase.td\"\n include \"triton/Dialect/Triton/IR/TritonTypes.td\"\n include \"triton/Dialect/Triton/IR/TritonAttrDefs.td\"\n include \"mlir/IR/OpBase.td\"\n-include \"mlir/Interfaces/SideEffectInterfaces.td\" // NoMemoryEffect\n+include \"mlir/Interfaces/SideEffectInterfaces.td\" // Pure\n include \"mlir/Interfaces/InferTypeOpInterface.td\" // SameOperandsAndResultType\n \n def ResultsAreSharedEncoding: NativeOpTrait<\"ResultsAreSharedEncoding\">;\n@@ -18,7 +18,7 @@ class TTG_Op<string mnemonic, list<Trait> traits = []> :\n def TTG_ConvertLayoutOp : TTG_Op<\"convert_layout\",\n                                  [SameOperandsAndResultShape,\n                                   SameOperandsAndResultElementType,\n-                                  NoMemoryEffect]> {\n+                                  Pure]> {\n   let summary = \"convert layout\";\n \n   let arguments = (ins TT_Tensor:$src);\n@@ -59,7 +59,7 @@ def TTG_AsyncCommitGroupOp : TTG_Op<\"async_commit_group\"> {\n // This is needed because these ops don't\n // handle encodings\n // e.g., https://github.com/llvm/llvm-project/blob/main/mlir/include/mlir/Dialect/Arith/IR/ArithOps.td#L111\n-def TTG_CmpIOp : TTG_Op<\"cmpi\", [NoMemoryEffect, Elementwise,\n+def TTG_CmpIOp : TTG_Op<\"cmpi\", [Pure, Elementwise,\n                                  SameOperandsAndResultShape, \n                                  SameOperandsAndResultEncoding]> {\n   let summary = \"integer comparison operation\";\n@@ -73,7 +73,7 @@ def TTG_CmpIOp : TTG_Op<\"cmpi\", [NoMemoryEffect, Elementwise,\n   let results = (outs TT_BoolLike:$result);\n }\n \n-def TTG_CmpFOp : TTG_Op<\"cmpf\", [NoMemoryEffect, Elementwise,\n+def TTG_CmpFOp : TTG_Op<\"cmpf\", [Pure, Elementwise,\n                                  SameOperandsAndResultShape, \n                                  SameOperandsAndResultEncoding]> {\n   let summary = \"floating-point comparison operation\";\n@@ -88,7 +88,7 @@ def TTG_CmpFOp : TTG_Op<\"cmpf\", [NoMemoryEffect, Elementwise,\n }\n \n // TODO: migrate to arith::SelectOp on LLVM16\n-def TTG_SelectOp : TTG_Op<\"select\", [NoMemoryEffect, Elementwise,\n+def TTG_SelectOp : TTG_Op<\"select\", [Pure, Elementwise,\n                                      SameOperandsAndResultShape,\n                                      SameOperandsAndResultEncoding]> {\n   let summary = \"select operation\";"}]