[{"filename": "python/triton/compiler.py", "status": "modified", "additions": 30, "deletions": 6, "changes": 36, "file_content_changes": "@@ -1067,6 +1067,7 @@ def format_of(ty):\n     # generate glue code\n     src = f\"\"\"\n #include \\\"cuda.h\\\"\n+#include <stdbool.h>\n #include <Python.h>\n \n static inline void gpuAssert(CUresult code, const char *file, int line)\n@@ -1092,12 +1093,22 @@ def format_of(ty):\n   }}\n }}\n \n-static inline CUdeviceptr getPointer(PyObject *obj, int idx) {{\n+typedef struct _DevicePtrInfo {{\n+    CUdeviceptr dev_ptr;\n+    bool valid;\n+}} DevicePtrInfo;\n+\n+static inline DevicePtrInfo getPointer(PyObject *obj, int idx) {{\n+  DevicePtrInfo ptr_info;\n+  ptr_info.dev_ptr = 0;\n+  ptr_info.valid = true;\n   if (PyLong_Check(obj)) {{\n-    return (CUdeviceptr)PyLong_AsUnsignedLongLong(obj);\n+    ptr_info.dev_ptr = PyLong_AsUnsignedLongLong(obj);\n+    return ptr_info;\n   }}\n   if (obj == Py_None) {{\n-    return (CUdeviceptr)0;\n+    // valid nullptr\n+    return ptr_info;\n   }}\n   PyObject *ptr = PyObject_GetAttrString(obj, \"data_ptr\");\n   if(ptr){{\n@@ -1107,11 +1118,21 @@ def format_of(ty):\n     Py_DECREF(ptr);\n     if (!PyLong_Check(ret)) {{\n       PyErr_SetString(PyExc_TypeError, \"data_ptr method of Pointer object must return 64-bit int\");\n+      ptr_info.valid = false;\n+      return ptr_info;\n+    }}\n+    PyObject *is_cuda = PyObject_GetAttrString(obj, \"is_cuda\");\n+    if (is_cuda && PyObject_RichCompareBool(is_cuda, Py_False, Py_EQ)) {{\n+       PyErr_Format(PyExc_ValueError, \"Pointer argument (at %d) must be on cuda\", idx);\n+       Py_DECREF(is_cuda);\n+        ptr_info.valid = false;\n+       return ptr_info;\n     }}\n-    return (CUdeviceptr)PyLong_AsUnsignedLongLong(ret);\n+    ptr_info.dev_ptr = PyLong_AsUnsignedLongLong(ret);\n+    return ptr_info;\n   }}\n   PyErr_SetString(PyExc_TypeError, \"Pointer argument must be either uint64 or have data_ptr method\");\n-  return (CUdeviceptr)0;\n+  return ptr_info;\n }}\n \n static PyObject* launch(PyObject* self, PyObject* args) {{\n@@ -1135,7 +1156,10 @@ def format_of(ty):\n     Py_DECREF(new_args);\n   }}\n \n-  _launch(gridX, gridY, gridZ, num_warps, shared_memory, (CUstream)_stream, (CUfunction)_function, {', '.join(f\"getPointer(_arg{i},{i})\" if ty[0]==\"*\" else f\"_arg{i}\"for i, ty in signature.items())});\n+\n+  // raise exception asap\n+  {\"; \".join([f\"DevicePtrInfo ptr_info{i} = getPointer(_arg{i}, {i}); if (!ptr_info{i}.valid) return NULL;\" if ty[0] == \"*\" else \"\" for i, ty in signature.items()])};\n+  _launch(gridX, gridY, gridZ, num_warps, shared_memory, (CUstream)_stream, (CUfunction)_function, {', '.join(f\"ptr_info{i}.dev_ptr\" if ty[0]==\"*\" else f\"_arg{i}\"for i, ty in signature.items())});\n \n   if (launch_exit_hook != Py_None) {{\n     PyObject *new_args = NULL;"}]