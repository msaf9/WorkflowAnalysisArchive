[{"filename": "lib/Conversion/TritonGPUToLLVM/TritonGPUToLLVMPass.cpp", "status": "modified", "additions": 14, "deletions": 13, "changes": 27, "file_content_changes": "@@ -49,10 +49,11 @@ namespace ttng = mlir::triton::nvidia_gpu;\n \n namespace {\n \n-// pass named attrs (e.g., ws related attributes)\n-static void addNamedAttrs(Operation *op, ArrayRef<mlir::NamedAttribute> attrs) {\n+// pass ws related named attrs.\n+static void addWSNamedAttrs(Operation *op,\n+                            ArrayRef<mlir::NamedAttribute> attrs) {\n   for (const NamedAttribute attr : attrs)\n-    if (!op->hasAttr(attr.getName()))\n+    if (attr.getName() == \"async_agent\" || attr.getName() == \"agent.mutex_role\")\n       op->setAttr(attr.getName(), attr.getValue());\n }\n \n@@ -624,13 +625,13 @@ class ConvertTritonGPUToLLVM\n       auto newCvtType = RankedTensorType::get(shape, F16Ty, cvtEncoding);\n       auto newArg = builder.create<mlir::triton::FpToFpOp>(\n           cvtOp.getLoc(), newArgType, cvtOp.getOperand());\n-      addNamedAttrs(newArg, cvtOp->getAttrs());\n+      addWSNamedAttrs(newArg, cvtOp->getAttrs());\n       auto newCvt = builder.create<mlir::triton::gpu::ConvertLayoutOp>(\n           cvtOp.getLoc(), newCvtType, newArg);\n-      addNamedAttrs(newCvt, cvtOp->getAttrs());\n+      addWSNamedAttrs(newCvt, cvtOp->getAttrs());\n       auto newRet = builder.create<mlir::triton::FpToFpOp>(\n           cvtOp.getLoc(), cvtOp.getType(), newCvt.getResult());\n-      addNamedAttrs(newRet, cvtOp->getAttrs());\n+      addWSNamedAttrs(newRet, cvtOp->getAttrs());\n       cvtOp.replaceAllUsesWith(newRet.getResult());\n       cvtOp.erase();\n     });\n@@ -656,10 +657,10 @@ class ConvertTritonGPUToLLVM\n                 getOrder(srcMma), numWarps, threadsPerWarp, numCTAs));\n         auto tmp = builder.create<triton::gpu::ConvertLayoutOp>(\n             cvtOp.getLoc(), tmpType, cvtOp.getOperand());\n-        addNamedAttrs(tmp, cvtOp->getAttrs());\n+        addWSNamedAttrs(tmp, cvtOp->getAttrs());\n         auto newConvert = builder.create<triton::gpu::ConvertLayoutOp>(\n             cvtOp.getLoc(), dstType, tmp);\n-        addNamedAttrs(newConvert, cvtOp->getAttrs());\n+        addWSNamedAttrs(newConvert, cvtOp->getAttrs());\n         cvtOp.replaceAllUsesWith(newConvert.getResult());\n         cvtOp.erase();\n       }\n@@ -686,10 +687,10 @@ class ConvertTritonGPUToLLVM\n                 srcType.getElementType()));\n         auto tmp = builder.create<triton::gpu::ConvertLayoutOp>(\n             cvtOp.getLoc(), tmpType, cvtOp.getOperand());\n-        addNamedAttrs(tmp, cvtOp->getAttrs());\n+        addWSNamedAttrs(tmp, cvtOp->getAttrs());\n         auto newConvert = builder.create<triton::gpu::ConvertLayoutOp>(\n             cvtOp.getLoc(), dstType, tmp);\n-        addNamedAttrs(newConvert, cvtOp->getAttrs());\n+        addWSNamedAttrs(newConvert, cvtOp->getAttrs());\n         cvtOp.replaceAllUsesWith(newConvert.getResult());\n         cvtOp.erase();\n       }\n@@ -764,7 +765,7 @@ class ConvertTritonGPUToLLVM\n           /*boundaryCheck=*/nullptr, /*padding=*/nullptr,\n           insertSliceAsyncOp.getCache(), insertSliceAsyncOp.getEvict(),\n           insertSliceAsyncOp.getIsVolatile());\n-      addNamedAttrs(loadOp, insertSliceAsyncOp->getAttrs());\n+      addWSNamedAttrs(loadOp, insertSliceAsyncOp->getAttrs());\n \n       // insert_slice\n       auto axis = insertSliceAsyncOp.getAxis();\n@@ -780,7 +781,7 @@ class ConvertTritonGPUToLLVM\n       auto insertSliceOp = builder.create<tensor::InsertSliceOp>(\n           insertSliceAsyncOp.getLoc(), loadOp, insertSliceAsyncOp.getDst(),\n           offsets, sizes, strides);\n-      addNamedAttrs(insertSliceOp, insertSliceAsyncOp->getAttrs());\n+      addWSNamedAttrs(insertSliceOp, insertSliceAsyncOp->getAttrs());\n \n       // Replace\n       insertSliceAsyncOp.replaceAllUsesWith(insertSliceOp.getResult());\n@@ -802,7 +803,7 @@ class ConvertTritonGPUToLLVM\n         OpBuilder builder(asyncWaitOp);\n         auto newWaitOp =\n             builder.create<triton::gpu::AsyncWaitOp>(asyncWaitOp.getLoc(), 0);\n-        addNamedAttrs(newWaitOp, asyncWaitOp->getAttrs());\n+        addWSNamedAttrs(newWaitOp, asyncWaitOp->getAttrs());\n         asyncWaitOp.erase();\n       }\n     });"}]