[{"filename": "python/triton/compiler/compiler.py", "status": "modified", "additions": 35, "deletions": 3, "changes": 38, "file_content_changes": "@@ -345,6 +345,36 @@ def get_architecture_descriptor(capability):\n     return capability\n \n \n+def get_architecture_num_warps(device_type, capability=None):\n+    if device_type in [\"cuda\", \"hip\"]:\n+        arch = get_architecture_descriptor(capability)\n+    else:\n+        _device_backend = get_backend(device_type)\n+        assert _device_backend\n+        arch = _device_backend.get_architecture_descriptor(device_type=device_type, capability=capability)\n+\n+    is_cuda = device_type == \"cuda\" and _is_cuda(arch)\n+    is_hip = device_type in [\"cuda\", \"hip\"] and not is_cuda\n+    num_warps = 4 if is_cuda or is_hip else arch[\"num_warps\"]\n+\n+    return num_warps\n+\n+\n+def get_architecture_num_stages(device_type, capability=None):\n+    if device_type in [\"cuda\", \"hip\"]:\n+        arch = get_architecture_descriptor(capability)\n+    else:\n+        _device_backend = get_backend(device_type)\n+        assert _device_backend\n+        arch = _device_backend.get_architecture_descriptor(device_type=device_type, capability=capability)\n+\n+    is_cuda = device_type == \"cuda\" and _is_cuda(arch)\n+    is_hip = device_type in [\"cuda\", \"hip\"] and not is_cuda\n+    num_stages = 3 if is_cuda and arch >= 75 else 2\n+\n+    return num_stages\n+\n+\n def add_rocm_stages(arch, extern_libs, stages):\n     extern_libs.update(get_amdgcn_bitcode_paths(arch))\n \n@@ -373,10 +403,11 @@ def add_cuda_stages(arch, extern_libs, stages):\n def compile(fn, **kwargs):\n     # Get device type to decide which backend should be used\n     device_type = kwargs.get(\"device_type\", \"cuda\")\n+    capability = kwargs.get(\"cc\", None)\n     _device_backend = get_backend(device_type)\n \n     if device_type in [\"cuda\", \"hip\"]:\n-        arch = get_architecture_descriptor(kwargs.get(\"cc\", None))\n+        arch = get_architecture_descriptor(capability)\n     else:\n         _device_backend = get_backend(device_type)\n         assert _device_backend\n@@ -386,8 +417,9 @@ def compile(fn, **kwargs):\n     is_hip = device_type in [\"cuda\", \"hip\"] and not is_cuda\n     context = ir.context()\n     constants = kwargs.get(\"constants\", dict())\n-    num_warps = kwargs.get(\"num_warps\", 4)\n-    num_stages = kwargs.get(\"num_stages\", 3 if is_cuda and arch >= 75 else 2)\n+    num_warps = kwargs.get(\"num_warps\", get_architecture_num_warps(device_type, capability))\n+    assert num_warps > 0 and (num_warps & (num_warps - 1)) == 0, \"num_warps must be a power of 2\"\n+    num_stages = kwargs.get(\"num_stages\", get_architecture_num_stages(device_type, capability))\n     extern_libs = kwargs.get(\"extern_libs\", dict())\n     if extern_libs is None:\n         extern_libs = dict()"}, {"filename": "python/triton/runtime/jit.py", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "file_content_changes": "@@ -319,15 +319,11 @@ def _make_launcher(self):\n         args_signature = ', '.join(name if dflt == inspect._empty else f'{name} = {dflt}' for name, dflt in zip(self.arg_names, self.arg_defaults))\n \n         src = f\"\"\"\n-def {self.fn.__name__}({args_signature}, grid=None, num_warps=4, num_stages=3, extern_libs=None, stream=None, warmup=False, device=None, device_type=None):\n-    from ..compiler import compile, CompiledKernel\n+def {self.fn.__name__}({args_signature}, grid=None, num_warps=None, num_stages=None, extern_libs=None, stream=None, warmup=False, device=None, device_type=None):\n+    from ..compiler import compile, CompiledKernel, get_architecture_num_warps, get_architecture_num_stages\n     sig_key =  {sig_keys},\n     constexpr_key = {f'{constexpr_keys},' if len(constexpr_keys) > 0 else ()}\n     spec_key = {f'{spec_keys},' if len(spec_keys) > 0 else ()}\n-    key = (version_key, sig_key, constexpr_key, spec_key, num_warps, num_stages, self.debug)\n-    if not extern_libs is None:\n-      key = (key, tuple(extern_libs.items()))\n-    assert num_warps > 0 and (num_warps & (num_warps - 1)) == 0, \"num_warps must be a power of 2\"\n     assert grid is not None\n     if callable(grid):\n         grid = grid({{{grid_args}}})\n@@ -345,6 +341,15 @@ def {self.fn.__name__}({args_signature}, grid=None, num_warps=4, num_stages=3, e\n         device_backend = get_backend(device_type)\n         if device_backend is None:\n             raise ValueError('Cannot find backend for ' + device_type)\n+    \n+    if num_warps is None:\n+        num_warps = get_architecture_num_warps(device_type)\n+    if num_stages is None:\n+        num_stages = get_architecture_num_stages(device_type)\n+    \n+    key = (version_key, sig_key, constexpr_key, spec_key, num_warps, num_stages, self.debug)\n+    if not extern_libs is None:\n+      key = (key, tuple(extern_libs.items()))\n \n     if device is None:\n         if device_type in ['cuda', 'hip']:"}]